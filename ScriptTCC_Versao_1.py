# -*- coding: utf-8 -*-
"""
Created on Sun Jun  8 16:17:29 2025

@author: Renata Alves
"""
#%%
# Intala√ß√£o de Pacotes

!pip install pandas
!pip install numpy
!pip install seaborn
!pip install matplotlib
!pip install plotly
!pip install scipy
!pip install statsmodels
!pip install scikit-learn
!pip install statstests
!pip install xgboost
!pip install openpyxl

#%%
# Importa√ß√£o dos Pacotes 

import pandas as pd # manipula√ß√£o de dados em formato de dataframe
import numpy as np # opera√ß√µes matem√°ticas
import seaborn as sns # visualiza√ß√£o gr√°fica
import matplotlib.pyplot as plt # visualiza√ß√£o gr√°fica
import plotly.graph_objects as go # gr√°ficos 3D
from scipy.stats import pearsonr # correla√ß√µes de Pearson
import statsmodels.api as sm # estima√ß√£o de modelos
from statsmodels.iolib.summary2 import summary_col # compara√ß√£o entre modelos
from sklearn.preprocessing import LabelEncoder # transforma√ß√£o de dados
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score
from sklearn.metrics import roc_auc_score, roc_curve
import xgboost as xgb
from xgboost import XGBClassifier
from xgboost.callback import EarlyStopping
import os
from datetime import datetime

#%%
# Sele√ß√£o o diret√≥rio com arquivos

os.chdir(r'C:\Users\Renata Alves\TCC')

#%%
# Importa√ß√£o dos Dados

vendas22 = pd.read_excel('vendas2022.xlsx', parse_dates=['Data Emiss√£o'])
vendas23 = pd.read_excel('vendas2023.xlsx', parse_dates=['Data Emiss√£o'])
produtos22 = pd.read_excel('produtos2022.xlsx')
produtos23 = pd.read_excel('produtos2023.xlsx')
produtos24 = pd.read_excel('produtos2024.xlsx')
vendas24real = pd.read_excel('vendas2024.xlsx', parse_dates=['Data Emiss√£o'])

#%%
# Informa√ß√µes gerais sobre o DataFrame
    #Sobre VENDAS
print(vendas22.info())
print(vendas23.info())
print(vendas24real.info())
    #Sobre PRODUTOS
print(produtos22.info())
print(produtos23.info())
print(produtos24.info())

#%%
# Lista das colunas que quero transformar Vari√°veis de Vendas em string
colunas_para_str = ['Representante', 'Cliente', 'Marca', 'Pedido', 'Variante', 'Produto', 'Cor']

# Aplicar a convers√£o dos tipos das vari√°veis de Vendas
vendas22[colunas_para_str] = vendas22[colunas_para_str].astype(str)
vendas23[colunas_para_str] = vendas23[colunas_para_str].astype(str)
vendas24real[colunas_para_str] = vendas24real[colunas_para_str].astype(str)

#Ajuste nos tipos de Vari√°veis em Produtos
produtos22['Refer√™ncia'] = produtos22['Refer√™ncia'].astype(str)
produtos23['Refer√™ncia'] = produtos23['Refer√™ncia'].astype(str)
produtos24['Refer√™ncia'] = produtos24['Refer√™ncia'].astype(str)

#%%
# Estat√≠sticas descritiva das vari√°veis
    #Sobre VENDAS
print(vendas22.describe())
print(vendas23.describe())

    #Sobre PRODUTOS
print(produtos22.describe())
print(produtos23.describe())
print(produtos24.describe())


#%%
# AN√ÅLISE EXPLORAT√ìRIA DOS DADOS

#%%
#Compara√ß√£o do volume de vendas entre 2022 e 2023 (Qtde Pe√ßas e R$)

# Agrupar vendas por ano
vendas_ano_22 = vendas22[['Quantidade Pedida Por Variante', 'Valor Pedido por Variante']].sum()
vendas_ano_23 = vendas23[['Quantidade Pedida Por Variante', 'Valor Pedido por Variante']].sum()

# Definir estilo visual
sns.set(style='whitegrid')

# Dados das Vendas
df_vendas = pd.DataFrame({
    'Ano': ['2022', '2023'],
    'Qtd Pe√ßas': [vendas_ano_22[0], vendas_ano_23[0]],
    'Valor R$': [vendas_ano_22[1], vendas_ano_23[1]]})

# Criar figura
fig, ax1 = plt.subplots(figsize=(8,6))

# Quantidade de Pe√ßas - nas barras
cor_barras = '#4C72B0'
ax1.bar(df_vendas['Ano'], df_vendas['Qtd Pe√ßas'], color=cor_barras, width=0.4)
ax1.set_xlabel('Ano', fontsize=12)
ax1.set_ylabel('Quantidade de Pe√ßas', color=cor_barras, fontsize=12)
ax1.tick_params(axis='y', labelcolor=cor_barras)

for i, v in enumerate(df_vendas['Qtd Pe√ßas']):
    ax1.text(i, v + v*0.02, f'{int(v):,}', ha='center', color=cor_barras, fontsize=10, fontweight='bold')

# Valor em Reais - nas linhas
ax2 = ax1.twinx()
cor_linha = '#C44E52'
ax2.plot(df_vendas['Ano'], df_vendas['Valor R$'], color=cor_linha, marker='o', linewidth=2)
ax2.set_ylabel('Valor em R$', color=cor_linha, fontsize=12)
ax2.tick_params(axis='y', labelcolor=cor_linha)

for i, v in enumerate(df_vendas['Valor R$']):
    ax2.text(i, v + v*0.02, f'R$ {int(v):,}', ha='center', color=cor_linha, fontsize=10, fontweight='bold')

# üîß T√≠tulo e grid
plt.title('Compara√ß√£o de Vendas ‚Äì Quantidade de Pe√ßas (Barras) e Valor em R$ (Linha)', fontsize=13, weight='bold')
ax1.grid(axis='y', linestyle='--', alpha=0.7)

plt.tight_layout()
plt.show()

#%%
# Compara√ß√£o da quantidade de refer√™ncias dispon√≠veis nos anos 2022, 2023 e 2024

qtd_ref_22 = produtos22['Refer√™ncia'].nunique()
qtd_ref_23 = produtos23['Refer√™ncia'].nunique()
qtd_ref_24 = produtos24['Refer√™ncia'].nunique()

df_ref = pd.DataFrame({
    'Ano': ['2022', '2023', '2024'],
    'Qtd de Refs': [qtd_ref_22, qtd_ref_23, qtd_ref_24]})

ax = sns.barplot(data=df_ref, x='Ano', y='Qtd de Refs', color='#4C72B0')

# T√≠tulo
plt.title('Quantidade de Refer√™ncias Dispon√≠veis para Vendas por Ano')

# üî• Adicionar os r√≥tulos de valor em cima de cada barra
for i, v in enumerate(df_ref['Qtd de Refs']):
    ax.text(i, v + v * 0.02,  # posi√ß√£o: eixo x = i, eixo y = levemente acima do topo da barra
            str(v),            # o valor que ser√° mostrado
            ha='center',       # alinhamento horizontal
            fontsize=10,       # tamanho da fonte
            fontweight='bold', # negrito
            color=cor_barras)

plt.tight_layout()
plt.show()

#%%
# An√°lise gr√°fica comparativa das vendas mensais entre 2022 e 2023 

# Criar coluna 'Mes' (n√∫mero do m√™s) para ambos os anos
vendas22['Mes'] = vendas22['Data Emiss√£o'].dt.month
vendas23['Mes'] = vendas23['Data Emiss√£o'].dt.month

# Agrupar vendas mensais (independente do ano)
vendas_mes_22 = vendas22.groupby('Mes')['Quantidade Pedida Por Variante'].sum().reset_index()
vendas_mes_23 = vendas23.groupby('Mes')['Quantidade Pedida Por Variante'].sum().reset_index()

# Mudan√ßa do n√∫mero do m√™s para nome
meses_nome = {
    1: 'Jan', 2: 'Fev', 3: 'Mar', 4: 'Abr', 5: 'Mai', 6: 'Jun',
    7: 'Jul', 8: 'Ago', 9: 'Set', 10: 'Out', 11: 'Nov', 12: 'Dez'}

vendas_mes_22['MesNome'] = vendas_mes_22['Mes'].map(meses_nome)
vendas_mes_23['MesNome'] = vendas_mes_23['Mes'].map(meses_nome)

# Constru√ß√£o do gr√°fico
plt.figure(figsize=(9,6))
sns.set(style='whitegrid')

plt.plot(vendas_mes_22['MesNome'], vendas_mes_22['Quantidade Pedida Por Variante'], 
         marker='o', color='#4C72B0', linewidth=2, label='2022')

plt.plot(vendas_mes_23['MesNome'], vendas_mes_23['Quantidade Pedida Por Variante'], 
         marker='o', color='#C44E52', linewidth=2, label='2023')

for x, y in zip(vendas_mes_22['MesNome'], vendas_mes_22['Quantidade Pedida Por Variante']):
    plt.text(x, y + y*0.02, f'{int(y):,}', ha='center', fontsize=9, color='#4C72B0')

for x, y in zip(vendas_mes_23['MesNome'], vendas_mes_23['Quantidade Pedida Por Variante']):
    plt.text(x, y + y*0.02, f'{int(y):,}', ha='center', fontsize=9, color='#C44E52')

plt.title('Comparativo da Evolu√ß√£o das Vendas Mensais ‚Äì 2022 x 2023 (Por M√™s)', fontsize=14, weight='bold')
plt.ylabel('Quantidade Pedida', fontsize=11)
plt.xlabel('M√™s', fontsize=11)

plt.show()

#%% 
# Agrupando as duas tabelas por ano (2022 e 2023)

# Renomear a coluna 'Produto' para 'Refer√™ncia' na tabela de vendas
vendas22 = vendas22.rename(columns={'Produto': 'Refer√™ncia'})
vendas23 = vendas23.rename(columns={'Produto': 'Refer√™ncia'})

# Merge das tabelas de vendas com produtos
vendas_prod22 = vendas22.merge(produtos22, on='Refer√™ncia', how='left')
vendas_prod23 = vendas23.merge(produtos23, on='Refer√™ncia', how='left')


#%%
# Gr√°fico do Comportamento das Vendas Anuais ‚Äì Separado por Categoria (2022 e 2023)

# Criar a tabela de vendas por categoria e ano
vendas_cat_22 = vendas_prod22.groupby('Categoria')['Quantidade Pedida Por Variante'].sum().reset_index()
vendas_cat_22['Ano'] = '2022'

vendas_cat_23 = vendas_prod23.groupby('Categoria')['Quantidade Pedida Por Variante'].sum().reset_index()
vendas_cat_23['Ano'] = '2023'

df_cat = pd.concat([vendas_cat_22, vendas_cat_23])

# Pivotar para organizar como tabela
tabela = df_cat.pivot(index='Categoria', columns='Ano', values='Quantidade Pedida Por Variante').fillna(0).astype(int)

# Calcular diferen√ßa percentual de 2022 para 2023
tabela['Diferen√ßa (%)'] = ((tabela['2023'] - tabela['2022']) / tabela['2022'].replace(0, 1)) * 100
tabela['Diferen√ßa (%)'] = tabela['Diferen√ßa (%)'].round(1)

# Ordenar pela quantidade de 2023 (opcional)
tabela = tabela.sort_values(by='Diferen√ßa (%)', ascending=False)

# Criando tabela 
tabela = tabela.reset_index()
tabela.columns = ['Categoria', '2022', '2023', 'Diferen√ßa (%)']

fig, ax = plt.subplots(figsize=(8, len(tabela) * 0.5))
ax.axis('off')  # Remove os eixos

tabela_plot = ax.table(cellText=tabela.values,
                        colLabels=tabela.columns,
                        loc='center',
                        cellLoc='center')

tabela_plot.auto_set_font_size(False)
tabela_plot.set_fontsize(10)
tabela_plot.scale(1.2, 1.2)

plt.title('Vendas por Categoria ‚Äì 2022 x 2023 + Diferen√ßa (%)', fontsize=14, weight='bold')
plt.tight_layout()

plt.show()

#%%
# Analise do comportamento de vendas por mes por regi√£o do pa√≠s nos anos de 2022 e 2023

# Dicion√°rio de mapeamento dos estados para regi√µes do Brasil
mapa_regioes = {
    'AC': 'Norte', 'AP': 'Norte', 'AM': 'Norte', 'PA': 'Norte', 'RO': 'Norte', 'RR': 'Norte', 'TO': 'Norte',
    'AL': 'Nordeste', 'BA': 'Nordeste', 'CE': 'Nordeste', 'MA': 'Nordeste', 'PB': 'Nordeste',
    'PE': 'Nordeste', 'PI': 'Nordeste', 'RN': 'Nordeste', 'SE': 'Nordeste',
    'DF': 'Centro-Oeste', 'GO': 'Centro-Oeste', 'MT': 'Centro-Oeste', 'MS': 'Centro-Oeste',
    'ES': 'Sudeste', 'MG': 'Sudeste', 'RJ': 'Sudeste', 'SP': 'Sudeste',
    'PR': 'Sul', 'RS': 'Sul', 'SC': 'Sul'}

# Criar coluna 'Regi√£o' em vendas2022 e vendas2023
vendas22['Regi√£o'] = vendas22['Estado'].map(mapa_regioes)
vendas23['Regi√£o'] = vendas23['Estado'].map(mapa_regioes)

# Obter a lista de regi√µes existentes
regioes = sorted(vendas22['Regi√£o'].dropna().unique())

# Loop para gerar um gr√°fico para cada regi√£o
for regiao in regioes:
    # Filtrar dados por regi√£o
    vendas22_reg = vendas22[vendas22['Regi√£o'] == regiao]
    vendas23_reg = vendas23[vendas23['Regi√£o'] == regiao]

    # Criar coluna 'Mes' (n√∫mero do m√™s)
    vendas22_reg['Mes'] = vendas22_reg['Data Emiss√£o'].dt.month
    vendas23_reg['Mes'] = vendas23_reg['Data Emiss√£o'].dt.month

    # Agrupar vendas mensais (independente do ano)
    vendas_mes_22 = vendas22_reg.groupby('Mes')['Quantidade Pedida Por Variante'].sum().reset_index()
    vendas_mes_23 = vendas23_reg.groupby('Mes')['Quantidade Pedida Por Variante'].sum().reset_index()

    meses_nome = {
        1: 'Jan', 2: 'Fev', 3: 'Mar', 4: 'Abr', 5: 'Mai', 6: 'Jun',
        7: 'Jul', 8: 'Ago', 9: 'Set', 10: 'Out', 11: 'Nov', 12: 'Dez'
    }

    vendas_mes_22['MesNome'] = vendas_mes_22['Mes'].map(meses_nome)
    vendas_mes_23['MesNome'] = vendas_mes_23['Mes'].map(meses_nome)

    # Criando Gr√°fico
    plt.figure(figsize=(9,6))
    sns.set(style='whitegrid')
    
    plt.plot(vendas_mes_22['MesNome'], vendas_mes_22['Quantidade Pedida Por Variante'], 
             marker='o', color='#4C72B0', linewidth=2, label='2022')

    plt.plot(vendas_mes_23['MesNome'], vendas_mes_23['Quantidade Pedida Por Variante'], 
             marker='o', color='#C44E52', linewidth=2, label='2023')

    for x, y in zip(vendas_mes_22['MesNome'], vendas_mes_22['Quantidade Pedida Por Variante']):
        plt.text(x, y + y*0.02, f'{int(y):,}', ha='center', fontsize=9, color='#4C72B0')

    for x, y in zip(vendas_mes_23['MesNome'], vendas_mes_23['Quantidade Pedida Por Variante']):
        plt.text(x, y + y*0.02, f'{int(y):,}', ha='center', fontsize=9, color='#C44E52')

    plt.title(f'Comparativo do Comportamento das Vendas Mensais ‚Äì Regi√£o {regiao}', fontsize=14, weight='bold')
    plt.ylabel('Quantidade Pedida', fontsize=11)
    plt.xlabel('M√™s', fontsize=11)

    plt.xticks(rotation=45)
    plt.grid(axis='y', linestyle='--', alpha=0.7)
    plt.legend(title='Ano', fontsize=10, title_fontsize=11)
    plt.tight_layout()

    plt.show()
 
#%%
# An√°lises de Correla√ß√£o das Vari√°veis (2022 e 2023 juntas)

# Concatenar as tabelas de vendas de 2022 e 2023
vendas_geral = pd.concat([vendas_prod22, vendas_prod23])

# Definir quais vari√°veis ser√£o inclu√≠das na an√°lise de correla√ß√£o
# Vari√°veis categ√≥ricas que ser√£o transformadas em dummies (one-hot)
variaveis_categoricas = ['Categoria', 'Modelagem', 'Linha', 'Grupo MP', 'Marca']

# Vari√°veis num√©ricas diretamente relacionadas ao volume e valor
variaveis_numericas = ['Quantidade Pedida Por Variante', 'Valor Pedido por Variante', 'Valor Unit√°rio da Variante']

# Selecionar apenas as colunas relevantes
dados_corr = vendas_geral[variaveis_numericas + variaveis_categoricas]

# Aplicar One Hot Encoding nas vari√°veis categ√≥ricas
dados_corr_encoded = pd.get_dummies(dados_corr, drop_first=False)

# Calcular a matriz de correla√ß√£o
corr = dados_corr_encoded.corr()

# Gerar o mapa de calor da correla√ß√£o
plt.figure(figsize=(12,10))
sns.heatmap(corr, annot=False, cmap='coolwarm', linewidths=0.5)

plt.title('Mapa de Correla√ß√£o ‚Äì Dados Gerais (2022 + 2023)', fontsize=14, weight='bold')
plt.tight_layout()
plt.show()

#%%
# An√°lises de Correla√ß√£o das Vari√°veis - correla√ß√µes fortes

# Gerar a matriz de correla√ß√£o
corr = dados_corr_encoded.corr()

# Filtrar apenas correla√ß√µes fortes (acima de 0.5 ou abaixo de -0.5)
corr_filtrada = corr[(corr >= 0.5) | (corr <= -0.5)]

plt.figure(figsize=(12,10))
sns.heatmap(corr_filtrada, annot=True, cmap='coolwarm', linewidths=0.5, fmt=".2f")
plt.title('Mapa de Correla√ß√£o ‚Äì Apenas Correla√ß√µes Fortes (2022 + 2023)', fontsize=14, weight='bold')
plt.tight_layout()
plt.show()

#%%

# Fun√ß√£o para gerar o mapa de correla√ß√£o para uma vari√°vel categ√≥rica
def mapa_correlacao_categoria(variavel_categorica, dados):
    # Selecionar colunas que cont√™m a vari√°vel categ√≥rica + vari√°veis num√©ricas
    colunas_categoricas = [col for col in dados.columns if variavel_categorica + '_' in col]
    colunas_numericas = ['Quantidade Pedida Por Variante', 'Valor Pedido por Variante', 'Valor Unit√°rio da Variante']
    
    colunas_interesse = colunas_categoricas + colunas_numericas
    
    # Calcular matriz de correla√ß√£o
    corr = dados[colunas_interesse].corr()

    # Selecionar s√≥ correla√ß√£o das categorias com as vari√°veis num√©ricas
    corr_interesse = corr.loc[colunas_categoricas, colunas_numericas]

    # Plotar
    plt.figure(figsize=(10, max(6, len(colunas_categoricas) * 0.5)))  # Ajusta altura conforme n¬∫ de categorias
    sns.heatmap(corr_interesse, annot=False, cmap='coolwarm', linewidths=0.5, cbar=True)

    plt.title(f'Mapa de Correla√ß√£o ‚Äì {variavel_categorica} vs Vari√°veis Num√©ricas', fontsize=14, weight='bold')
    plt.tight_layout()
    
    plt.show()


# Executar para todas as vari√°veis categ√≥ricas
variaveis_categoricas = ['Categoria', 'Modelagem', 'Linha', 'Grupo MP', 'Marca']

for variavel in variaveis_categoricas:
    mapa_correlacao_categoria(variavel, dados_corr_encoded)

#%%
# APLICA√á√ÉO DO XGBoost

#%%
# Dados de treino e teste: vendas + produtos de 2022 e 2023
# Agrupando dados dos dois anos
vendas_prod_22_23 = pd.concat([vendas_prod22, vendas_prod23], ignore_index=True)

# Verificar a jun√ß√£o
print(vendas_prod_22_23.info())
print(vendas_prod_22_23.head())

#%%
# Preparar os dados de treino (2022 + 2023)

# Agrupar vendas para obter a quantidade total vendida por Refer√™ncia
vendas_treino = vendas_prod_22_23.groupby('Refer√™ncia').agg({
    'Quantidade Pedida Por Variante': 'sum'}).reset_index()

# Juntar com as caracter√≠sticas dos produtos de 2024
base_treino = vendas_treino.merge(produtos24.drop_duplicates(subset='Refer√™ncia'), 
                                  on='Refer√™ncia', how='left')

#%%
# Preparar os dados de previs√£o (produtos de 2024)

base_previsao = produtos24.drop_duplicates(subset='Refer√™ncia')

#%%
# Definir vari√°veis preditoras (X) e vari√°vel alvo (y)

# Vari√°veis preditoras (features)
variaveis_categoricas = ['Categoria', 'Modelagem', 'Linha', 'Grupo MP']

# Aplicar One Hot Encoding
X = pd.get_dummies(base_treino[variaveis_categoricas + ['Refer√™ncia']], drop_first=False)

#  Vari√°vel alvo
y = base_treino['Quantidade Pedida Por Variante']

# Aplicar Encoding na base de previs√£o
X_previsao = pd.get_dummies(base_previsao[variaveis_categoricas + ['Refer√™ncia']], drop_first=False)
X_previsao = X_previsao.reindex(columns=X.columns, fill_value=0) #Alinhar colunas das bases

#%%
from xgboost.callback import EarlyStopping

#%%
# Treinar o modelo XGBoost

# Separar dados para treino e valida√ß√£o interna (80/20)
X_train, X_valid, y_train, y_valid = train_test_split(
    X, y, test_size=0.2, random_state=42)

# Criar o modelo
modelo = xgb.XGBRegressor(
    objective='reg:squarederror',
    n_estimators=500,
    learning_rate=0.05,
    max_depth=6,
    subsample=0.8,
    colsample_bytree=0.8,
    random_state=42,
    eval_metric='rmse')

# Treinar o modelo
modelo.fit(
    X_train, y_train,
    eval_set=[(X_train, y_train), (X_valid, y_valid)],
    verbose=True)

#%%
# Avaliar o modelo na valida√ß√£o interna
y_pred_valid = modelo.predict(X_valid)

rmse = np.sqrt(mean_squared_error(y_valid, y_pred_valid))
r2 = r2_score(y_valid, y_pred_valid)

print(f'Desempenho na valida√ß√£o interna:')
print(f'‚Üí RMSE: {rmse:.2f}')
print(f'‚Üí R¬≤: {r2:.2%}')

#%%
# Gerar previs√£o de vendas para os produtos de 2024
y_pred_2024 = modelo.predict(X_previsao)

# Montar tabela com os resultados
previsao_2024 = base_previsao[['Refer√™ncia']].copy()
previsao_2024['Previs√£o Qtde Venda'] = y_pred_2024.round(0).astype(int)

print(previsao_2024)

